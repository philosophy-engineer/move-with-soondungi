name: deploy-api

on:
  push:
    branches:
      - main
    paths:
      - apps/server/**
      - packages/shared/**
      - apps/server/Dockerfile
      - infra/prod/**
      - pnpm-lock.yaml
      - pnpm-workspace.yaml
      - package.json
      - .github/workflows/deploy-api.yml
  workflow_dispatch:
    inputs:
      rollback_image:
        description: "Full image ref for rollback (e.g. ghcr.io/org/soondungi-api:abcdef)"
        required: true
        type: string

concurrency:
  group: deploy-api
  cancel-in-progress: false

env:
  DEPLOY_PATH: /opt/soondungi/api
  API_PORT: "4000"
  IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/soondungi-api

jobs:
  build:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_ref: ${{ steps.meta.outputs.image_ref }}
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - id: meta
        run: echo "image_ref=${IMAGE_NAME}:${GITHUB_SHA}" >> "$GITHUB_OUTPUT"

      - uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/server/Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_ref }}
            ${{ env.IMAGE_NAME }}:latest

  deploy:
    if: github.event_name == 'push'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync compose file
        run: |
          ssh "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" "mkdir -p '${DEPLOY_PATH}'"
          scp infra/prod/docker-compose.api.yml "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${DEPLOY_PATH}/docker-compose.api.yml"

      - name: Deploy with migration and health check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          IMAGE_REF: ${{ needs.build.outputs.image_ref }}
        run: |
          ssh "$EC2_USER@$EC2_HOST" "export DEPLOY_PATH='${DEPLOY_PATH}' API_PORT='${API_PORT}' IMAGE_REF='${IMAGE_REF}' GHCR_USERNAME='${GHCR_USERNAME}' GHCR_TOKEN='${GHCR_TOKEN}'; bash -s" <<'EOF'
          set -euo pipefail

          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
          }

          cd "$DEPLOY_PATH"

          if [ ! -f .env.api ]; then
            echo "Missing $DEPLOY_PATH/.env.api"
            exit 1
          fi

          docker_cmd() { docker "$@"; }
          if ! docker info >/dev/null 2>&1; then
            if sudo -n docker info >/dev/null 2>&1; then
              docker_cmd() { sudo docker "$@"; }
            else
              echo "Docker daemon access denied for user '$USER'."
              echo "Add the user to docker group or allow passwordless sudo for docker."
              exit 1
            fi
          fi

          PREVIOUS_IMAGE="$(cat .last_successful_image 2>/dev/null || true)"
          echo "$IMAGE_REF" > .last_attempted_image

          log "Login to ghcr.io"
          echo "$GHCR_TOKEN" | docker_cmd login ghcr.io -u "$GHCR_USERNAME" --password-stdin
          log "Pull image: $IMAGE_REF"
          docker_cmd pull "$IMAGE_REF"

          write_compose_env() {
            printf 'API_IMAGE=%s\nAPI_PORT=%s\n' "$1" "$API_PORT" > .deploy.compose.env
          }

          write_compose_env "$IMAGE_REF"
          log "Run migrations"
          docker_cmd compose --env-file .deploy.compose.env -f docker-compose.api.yml run --rm --no-deps api node dist/scripts/run-migrations.js
          log "Start api container"
          docker_cmd compose --env-file .deploy.compose.env -f docker-compose.api.yml up -d api
          docker_cmd compose --env-file .deploy.compose.env -f docker-compose.api.yml ps api || true

          log "Health check: http://127.0.0.1:${API_PORT}/healthz"
          if curl -fsS --retry 10 --retry-delay 3 --connect-timeout 2 --max-time 5 "http://127.0.0.1:${API_PORT}/healthz" >/dev/null; then
            log "Health check passed"
            echo "$IMAGE_REF" > .last_successful_image
            rm -f .deploy.compose.env
            exit 0
          fi

          echo "Health check failed for $IMAGE_REF"
          docker_cmd compose --env-file .deploy.compose.env -f docker-compose.api.yml logs --tail=200 api || true

          if [ -n "$PREVIOUS_IMAGE" ]; then
            echo "Rolling back to $PREVIOUS_IMAGE"
            write_compose_env "$PREVIOUS_IMAGE"
            docker_cmd compose --env-file .deploy.compose.env -f docker-compose.api.yml up -d api
            curl -fsS --retry 10 --retry-delay 3 --connect-timeout 2 --max-time 5 "http://127.0.0.1:${API_PORT}/healthz" >/dev/null
          fi

          rm -f .deploy.compose.env
          exit 1
          EOF

  rollback:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Roll back to selected image
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          IMAGE_REF: ${{ inputs.rollback_image }}
        run: |
          ssh "$EC2_USER@$EC2_HOST" "export DEPLOY_PATH='${DEPLOY_PATH}' API_PORT='${API_PORT}' IMAGE_REF='${IMAGE_REF}' GHCR_USERNAME='${GHCR_USERNAME}' GHCR_TOKEN='${GHCR_TOKEN}'; bash -s" <<'EOF'
          set -euo pipefail

          log() {
            echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*"
          }

          cd "$DEPLOY_PATH"

          if [ ! -f .env.api ]; then
            echo "Missing $DEPLOY_PATH/.env.api"
            exit 1
          fi

          docker_cmd() { docker "$@"; }
          if ! docker info >/dev/null 2>&1; then
            if sudo -n docker info >/dev/null 2>&1; then
              docker_cmd() { sudo docker "$@"; }
            else
              echo "Docker daemon access denied for user '$USER'."
              echo "Add the user to docker group or allow passwordless sudo for docker."
              exit 1
            fi
          fi

          log "Login to ghcr.io"
          echo "$GHCR_TOKEN" | docker_cmd login ghcr.io -u "$GHCR_USERNAME" --password-stdin
          log "Pull image: $IMAGE_REF"
          docker_cmd pull "$IMAGE_REF"

          printf 'API_IMAGE=%s\nAPI_PORT=%s\n' "$IMAGE_REF" "$API_PORT" > .deploy.compose.env
          log "Start api container"
          docker_cmd compose --env-file .deploy.compose.env -f docker-compose.api.yml up -d api
          log "Health check: http://127.0.0.1:${API_PORT}/healthz"
          curl -fsS --retry 10 --retry-delay 3 --connect-timeout 2 --max-time 5 "http://127.0.0.1:${API_PORT}/healthz" >/dev/null
          log "Health check passed"
          rm -f .deploy.compose.env

          echo "$IMAGE_REF" > .last_successful_image
          EOF
